#
initial_state: 'on'
alias: 'Returned home'
trigger:
  - platform: state
    entity_id: binary_sensor.front_door_sensor
    to: 'on'
  # People nearly home
  - platform: numeric_state
    entity_id: proximity.person3_home
    below: 500
  - platform: numeric_state
    entity_id: proximity.person1_home
    below: 500
  - platform: numeric_state
    entity_id: proximity.person2_home
    below: 500
  # Should also include some travel time magic here
  # Basically, travel time < 15 for 10 minutes, travelling towards home
condition:
  condition: and
  conditions: 
    - condition: state
      entity_id: input_boolean.lighting_automations
      state: 'on'
    - condition: numeric_state
      entity_id: sensor.living_room_multi_luminance
      below: 15
    # Hall light is off
    - condition: or
      conditions:
      - condition: state
        entity_id: switch.hall_downstairs_switch
        state: 'off'
      - condition: state
        entity_id: light.hall
        state: 'off'
    # Somebody is nearly home, or just arrived
    - condition: or
      conditions: 
      - condition: and
        conditions:
        - condition: template
          value_template: "{{ is_state_attr('proximity.person3_home', 'dir_of_travel', 'towards') }}"
        - condition: numeric_state
          entity_id: proximity.person3_home
          below: 500
        - condition: state
          entity_id: input_select.person3_status_dropdown
          state: Away
      - condition: and
        conditions:
        - condition: template
          value_template: "{{ is_state_attr('proximity.person1_home', 'dir_of_travel', 'towards') }}"
        - condition: numeric_state
          entity_id: proximity.person1_home
          below: 500
        - condition: state
          entity_id: input_select.person1_status_dropdown
          state: Away
      - condition: and
        conditions:
        - condition: template
          value_template: "{{ is_state_attr('proximity.person2_home', 'dir_of_travel', 'towards') }}"
        - condition: numeric_state
          entity_id: proximity.person2_home
          below: 500
        - condition: state
          entity_id: input_select.person2_status_dropdown
          state: Away
      - condition: template
        value_template: "{{ is_state('group.person_person1','home') or is_state('input_select.person1_status_dropdown','Just Arrived') }}"
      - condition: template
        value_template: "{{ is_state('group.person_person2','home') or is_state('input_select.person2_status_dropdown','Just Arrived') }}"
      - condition: template
        value_template: "{{ is_state('group.person_person3','home') or is_state('input_select.person3_status_dropdown','Just Arrived') }}"
      # Or an exterior door has been opened in the last 5 minutes
      - condition: template
        value_template: "{{ (as_timestamp(now()) - as_timestamp(states.sensor.last_opened.last_updated)) | int < 300 }}"
action:
  - service_template: >-
      {% if is_state('input_select.season', 'Christmas') %}
        script.hall_string_on
      {% else %}
        script.hall_strip_on
      {% endif %}
  - service: notify.logfile
    data_template:
      message: >
        Returned home triggered at {{ now() }} by {{ trigger.entity_id }}, was {{ trigger.from_state.state }} is {{ trigger.to_state.state }}
          person1's proximity: {{ states('proximity.person1_home') }}
          person3's proximity: {{ states('proximity.person3_home') }}
          person2's proximity: {{ states('proximity.person2_home') }}
          Trackers home already: {{ (dict((states|selectattr('entity_id', 'in', state_attr('group.person_person2', 'entity_id'))|list)|groupby('state'))['home']|default([]) + dict((states|selectattr('entity_id', 'in', state_attr('group.person_person3', 'entity_id'))|list)|groupby('state'))['home']|default([]) + dict((states|selectattr('entity_id', 'in', state_attr('group.person_person1', 'entity_id'))|list)|groupby('state'))['home']|default([]))|count }}
          Door was opened {{ (as_timestamp(now()) - as_timestamp(states.sensor.last_opened.last_updated)) | int }} seconds ago
